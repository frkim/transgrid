@page
@model IndexModel
@{
    ViewData["Title"] = "OpsAPI - Train Operational Plans";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="gradient-text">
        <i class="bi bi-train-front"></i> OpsAPI - Train Operational Plans
    </h1>
</div>

<!-- Stats Row - Clickable Filters -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white stat-card" data-filter="ALL" role="button" style="cursor: pointer;">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-collection"></i> Total</h5>
                <h2 id="totalCount">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white stat-card" data-filter="ACTIVE" role="button" style="cursor: pointer;">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-check-circle"></i> Active</h5>
                <h2 id="activeCount">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark stat-card" data-filter="DELAYED" role="button" style="cursor: pointer;">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-clock-history"></i> Delayed</h5>
                <h2 id="delayedCount">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white stat-card" data-filter="CANCELLED" role="button" style="cursor: pointer;">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-x-circle"></i> Cancelled</h5>
                <h2 id="cancelledCount">-</h2>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-lg mb-4">
    <div class="card-header bg-gradient text-white">
        <div class="row align-items-center">
            <div class="col-md-8">
                <i class="bi bi-search"></i> Search & Filter
            </div>
            <div class="col-md-4 text-end">
                <span id="record-count" class="badge bg-light text-dark">0 records</span>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="searchBox" class="form-control" placeholder="Search...">
                </div>
            </div>
            <div class="col-md-2">
                <select id="filterPathway" class="form-select">
                    <option value="">All Pathways</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="filterOrigin" class="form-select">
                    <option value="">All Origins</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="filterDestination" class="form-select">
                    <option value="">All Destinations</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="filterCountry" class="form-select">
                    <option value="">All Countries</option>
                </select>
            </div>
        </div>
        <div class="mt-2">
            <button class="btn btn-sm btn-outline-secondary" id="clearFiltersBtn">
                <i class="bi bi-x-circle"></i> Clear All Filters
            </button>
        </div>
    </div>
</div>

<div class="card shadow-lg">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-striped" id="dataTable">
                <thead class="table-dark">
                    <tr>
                        <th class="sortable" data-column="serviceCode">
                            Service Code <i class="bi bi-arrow-down-up"></i>
                        </th>
                        <th class="sortable" data-column="pathway">
                            Pathway <i class="bi bi-arrow-down-up"></i>
                        </th>
                        <th class="sortable" data-column="travelDate">
                            Travel Date <i class="bi bi-arrow-down-up"></i>
                        </th>
                        <th class="sortable" data-column="origin">
                            Origin <i class="bi bi-arrow-down-up"></i>
                        </th>
                        <th class="sortable" data-column="destination">
                            Destination <i class="bi bi-arrow-down-up"></i>
                        </th>
                        <th class="sortable" data-column="status">
                            Status <i class="bi bi-arrow-down-up"></i>
                        </th>
                        <th class="sortable" data-column="country">
                            Country <i class="bi bi-arrow-down-up"></i>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient text-white">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> Train Plan Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailContent">
                <!-- Content will be populated dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let allData = [];
    let sortColumn = 'serviceCode';
    let sortDirection = 'asc';
    let activeFilter = 'ALL';
    
    // HTML escape function to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    async function loadData() {
        try {
            const response = await fetch('/api/OpsApi');
            allData = await response.json();
            updateStats();
            populateFilterDropdowns();
            renderTable();
        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('tableBody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>';
        }
    }
    
    function populateFilterDropdowns() {
        const pathways = [...new Set(allData.map(x => x.pathway))].sort();
        const origins = [...new Set(allData.map(x => x.origin))].sort();
        const destinations = [...new Set(allData.map(x => x.destination))].sort();
        const countries = [...new Set(allData.map(x => x.country))].sort();
        
        populateSelect('filterPathway', pathways, 'All Pathways');
        populateSelect('filterOrigin', origins, 'All Origins');
        populateSelect('filterDestination', destinations, 'All Destinations');
        populateSelect('filterCountry', countries, 'All Countries');
    }
    
    function populateSelect(id, values, defaultLabel) {
        const select = document.getElementById(id);
        const currentValue = select.value;
        select.innerHTML = `<option value="">${defaultLabel}</option>` + 
            values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
        select.value = currentValue;
    }
    
    function updateStats() {
        const total = allData.length;
        const active = allData.filter(x => x.status === 'ACTIVE').length;
        const delayed = allData.filter(x => x.status === 'DELAYED').length;
        const cancelled = allData.filter(x => x.status === 'CANCELLED').length;
        
        document.getElementById('totalCount').textContent = total;
        document.getElementById('activeCount').textContent = active;
        document.getElementById('delayedCount').textContent = delayed;
        document.getElementById('cancelledCount').textContent = cancelled;
    }
    
    function setFilter(filter) {
        activeFilter = filter;
        
        // Update card styles to show active state
        document.querySelectorAll('.stat-card').forEach(card => {
            card.classList.remove('border', 'border-4', 'border-dark');
            card.style.opacity = '0.7';
        });
        
        const activeCard = document.querySelector(`.stat-card[data-filter="${filter}"]`);
        if (activeCard) {
            activeCard.classList.add('border', 'border-4', 'border-dark');
            activeCard.style.opacity = '1';
        }
        
        renderTable();
    }
    
    function renderTable() {
        const searchTerm = document.getElementById('searchBox').value.toLowerCase();
        const pathwayFilter = document.getElementById('filterPathway').value;
        const originFilter = document.getElementById('filterOrigin').value;
        const destinationFilter = document.getElementById('filterDestination').value;
        const countryFilter = document.getElementById('filterCountry').value;
        
        let filteredData = allData.filter(item => {
            // Apply status filter from stat cards
            if (activeFilter !== 'ALL' && item.status !== activeFilter) {
                return false;
            }
            // Apply dropdown filters
            if (pathwayFilter && item.pathway !== pathwayFilter) return false;
            if (originFilter && item.origin !== originFilter) return false;
            if (destinationFilter && item.destination !== destinationFilter) return false;
            if (countryFilter && item.country !== countryFilter) return false;
            
            // Apply search filter
            return (
                item.serviceCode.toLowerCase().includes(searchTerm) ||
                item.pathway.toLowerCase().includes(searchTerm) ||
                item.origin.toLowerCase().includes(searchTerm) ||
                item.destination.toLowerCase().includes(searchTerm) ||
                item.status.toLowerCase().includes(searchTerm) ||
                item.country.toLowerCase().includes(searchTerm)
            );
        });
        
        // Sort data
        filteredData.sort((a, b) => {
            let aVal = a[sortColumn];
            let bVal = b[sortColumn];
            
            if (sortColumn === 'travelDate') {
                aVal = new Date(aVal);
                bVal = new Date(bVal);
            }
            
            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });
        
        document.getElementById('record-count').textContent = `${filteredData.length} records`;
        
        const tbody = document.getElementById('tableBody');
        if (filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No records found</td></tr>';
            return;
        }
        
        tbody.innerHTML = filteredData.map(item => {
            const statusBadge = getStatusBadge(item.status);
            const travelDate = new Date(item.travelDate).toLocaleDateString();
            
            return `
                <tr>
                    <td><strong>${escapeHtml(item.serviceCode)}</strong></td>
                    <td><span class="badge bg-info">${escapeHtml(item.pathway)}</span></td>
                    <td>${escapeHtml(travelDate)}</td>
                    <td>${escapeHtml(item.origin)}</td>
                    <td>${escapeHtml(item.destination)}</td>
                    <td>${statusBadge}</td>
                    <td><span class="badge bg-secondary">${escapeHtml(item.country)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewDetails('${escapeHtml(item.id)}')">
                            <i class="bi bi-eye"></i> View
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function getStatusBadge(status) {
        const badges = {
            'ACTIVE': '<span class="badge bg-success">Active</span>',
            'CANCELLED': '<span class="badge bg-danger">Cancelled</span>',
            'DELAYED': '<span class="badge bg-warning text-dark">Delayed</span>'
        };
        return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
    }
    
    function viewDetails(id) {
        const item = allData.find(x => x.id === id);
        if (!item) return;
        
        const passagePoints = item.passagePoints.length > 0 
            ? item.passagePoints.map(p => `<span class="badge bg-light text-dark me-1">${p}</span>`).join('')
            : '<span class="text-muted">None</span>';
        
        document.getElementById('detailContent').innerHTML = `
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="fw-bold">Service Code:</label>
                    <p>${item.serviceCode}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="fw-bold">Status:</label>
                    <p>${getStatusBadge(item.status)}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="fw-bold">Pathway:</label>
                    <p><span class="badge bg-info">${item.pathway}</span></p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="fw-bold">Travel Date:</label>
                    <p>${new Date(item.travelDate).toLocaleString()}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="fw-bold">Origin:</label>
                    <p>${item.origin}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="fw-bold">Destination:</label>
                    <p>${item.destination}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="fw-bold">Country:</label>
                    <p><span class="badge bg-secondary">${item.country}</span></p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="fw-bold">Plan Type:</label>
                    <p>${item.planType}</p>
                </div>
                <div class="col-12 mb-3">
                    <label class="fw-bold">Passage Points:</label>
                    <p>${passagePoints}</p>
                </div>
                <div class="col-12 mb-3">
                    <label class="fw-bold">Created At:</label>
                    <p>${new Date(item.createdAt).toLocaleString()}</p>
                </div>
            </div>
        `;
        
        new bootstrap.Modal(document.getElementById('detailModal')).show();
    }
    
    // Event listeners
    document.getElementById('searchBox').addEventListener('input', renderTable);
    document.getElementById('filterPathway').addEventListener('change', renderTable);
    document.getElementById('filterOrigin').addEventListener('change', renderTable);
    document.getElementById('filterDestination').addEventListener('change', renderTable);
    document.getElementById('filterCountry').addEventListener('change', renderTable);
    
    document.getElementById('clearFiltersBtn').addEventListener('click', function() {
        document.getElementById('searchBox').value = '';
        document.getElementById('filterPathway').value = '';
        document.getElementById('filterOrigin').value = '';
        document.getElementById('filterDestination').value = '';
        document.getElementById('filterCountry').value = '';
        setFilter('ALL');
    });
    
    document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', function() {
            const column = this.dataset.column;
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('.sortable i').forEach(i => {
                i.className = 'bi bi-arrow-down-up';
            });
            this.querySelector('i').className = sortDirection === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
            
            renderTable();
        });
    });
    
    // Stat card click handlers for filtering
    document.querySelectorAll('.stat-card').forEach(card => {
        card.addEventListener('click', function() {
            const filter = this.dataset.filter;
            setFilter(filter);
        });
    });
    
    // Initialize with ALL filter active
    loadData().then(() => setFilter('ALL'));
</script>
}
