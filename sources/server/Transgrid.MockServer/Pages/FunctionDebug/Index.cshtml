@page
@model IndexModel
@{
    ViewData["Title"] = "Debug TransformTrainPlan Function";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="gradient-text">
        <i class="bi bi-bug"></i> Debug TransformTrainPlan Function
    </h1>
    <div class="d-flex align-items-center gap-2">
        <span class="badge bg-secondary" id="function-status">
            <i class="bi bi-circle"></i> Ready
        </span>
    </div>
</div>

<!-- Function URL Configuration -->
<div class="card shadow-lg mb-4">
    <div class="card-header bg-gradient text-white">
        <div class="row align-items-center">
            <div class="col">
                <i class="bi bi-gear"></i> Function Configuration
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row align-items-end g-3">
            <div class="col-md-6">
                <label for="functionUrl" class="form-label fw-bold">Function URL</label>
                <input type="text" class="form-control" id="functionUrl" 
                       value="@Model.FunctionUrl" 
                       placeholder="Enter the TransformTrainPlan function URL">
            </div>
            <div class="col-md-4">
                <label for="functionKey" class="form-label fw-bold">
                    Function Key <span class="text-muted fw-normal">(required for deployed functions)</span>
                </label>
                <div class="input-group">
                    <input type="password" class="form-control" id="functionKey" 
                           value="@Model.FunctionKey"
                           placeholder="Enter function key or leave empty for local">
                    <button class="btn btn-outline-secondary" type="button" onclick="toggleKeyVisibility()" title="Toggle visibility">
                        <i class="bi bi-eye" id="keyVisibilityIcon"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-primary btn-lg w-100" onclick="runFunction()">
                    <i class="bi bi-play-fill"></i> Run
                </button>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-12">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> 
                    Get the function key from Azure Portal → Function App → Functions → TransformTrainPlan → Function Keys
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Main Content - Two Columns -->
<div class="row g-4">
    <!-- Left Column - Input (JSON) -->
    <div class="col-lg-6">
        <div class="card shadow-lg h-100 input-card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-braces"></i> Input (JSON)</span>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-light" onclick="formatJson()" title="Format JSON">
                        <i class="bi bi-code-slash"></i> Format
                    </button>
                    <button type="button" class="btn btn-sm btn-light" onclick="loadSampleData()" title="Load Sample Data">
                        <i class="bi bi-file-earmark-code"></i> Sample
                    </button>
                    <button type="button" class="btn btn-sm btn-light" onclick="clearInput()" title="Clear">
                        <i class="bi bi-x-circle"></i> Clear
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="editor-container">
                    <div id="jsonEditor" class="code-editor"></div>
                </div>
            </div>
            <div class="card-footer bg-light">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Edit the JSON input above. Click "Run Function" to transform.
                </small>
            </div>
        </div>
    </div>

    <!-- Right Column - Output (XML) -->
    <div class="col-lg-6">
        <div class="card shadow-lg h-100 output-card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-file-earmark-code"></i> Output (XML)</span>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-light" onclick="copyOutput()" title="Copy to Clipboard">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                    <button type="button" class="btn btn-sm btn-light" onclick="downloadOutput()" title="Download XML">
                        <i class="bi bi-download"></i> Download
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="editor-container">
                    <div id="xmlViewer" class="code-viewer"></div>
                </div>
            </div>
            <div class="card-footer bg-light d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> XML output will appear here after execution.
                </small>
                <span id="execution-time" class="badge bg-secondary d-none">
                    <i class="bi bi-clock"></i> <span id="exec-time-value"></span>
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Error Display Panel -->
<div class="row mt-4" id="errorPanel" style="display: none;">
    <div class="col-12">
        <div class="card shadow-lg border-danger">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-exclamation-triangle"></i> Error Details</span>
                <button type="button" class="btn btn-sm btn-light" onclick="hideError()">
                    <i class="bi bi-x"></i> Dismiss
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <h6 class="fw-bold text-danger"><i class="bi bi-bug"></i> Error Message</h6>
                        <div id="errorMessage" class="alert alert-danger mb-0"></div>
                    </div>
                    <div class="col-12" id="stackTraceContainer" style="display: none;">
                        <h6 class="fw-bold text-danger"><i class="bi bi-stack"></i> Stack Trace</h6>
                        <pre id="stackTrace" class="bg-dark text-light p-3 rounded overflow-auto" style="max-height: 300px;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-primary fw-bold">Executing Function...</p>
    </div>
</div>

@section Scripts {
<!-- CodeMirror for syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/xml-fold.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css">

<style>
    .editor-container {
        height: 450px;
        border: 1px solid #dee2e6;
    }
    
    .CodeMirror {
        height: 100% !important;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 14px;
    }
    
    .input-card {
        border: 2px solid transparent;
        transition: border-color 0.3s ease;
    }
    
    .input-card:focus-within {
        border-color: #0dcaf0;
    }
    
    .output-card {
        border: 2px solid transparent;
        transition: border-color 0.3s ease;
    }
    
    .output-card.has-content {
        border-color: #198754;
    }
    
    .output-card.has-error {
        border-color: #dc3545;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .loading-content {
        text-align: center;
    }
    
    .card-header.bg-info {
        background: linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%) !important;
    }
    
    .card-header.bg-success {
        background: linear-gradient(135deg, #198754 0%, #157347 100%) !important;
    }
    
    .card-header.bg-danger {
        background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%) !important;
    }
    
    #errorMessage {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    #stackTrace {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 12px;
        white-space: pre;
        word-break: break-all;
    }
    
    .code-editor, .code-viewer {
        height: 100%;
    }
</style>

<script>
    let jsonEditor;
    let xmlViewer;
    let currentOutput = '';

    const sampleData = {
        id: "sample-001",
        serviceCode: "ES9123",
        pathway: "LON-PAR",
        travelDate: "@DateTime.Now.AddDays(1).ToString("yyyy-MM-dd")",
        passagePoints: [
            {
                locationCode: "LONDON_ST_PANCRAS",
                arrivalTime: null,
                departureTime: "08:30"
            },
            {
                locationCode: "ASHFORD_INTL",
                arrivalTime: "08:55",
                departureTime: "08:58"
            },
            {
                locationCode: "LILLE_EUROPE",
                arrivalTime: "10:20",
                departureTime: "10:25"
            },
            {
                locationCode: "PARIS_NORD",
                arrivalTime: "11:17",
                departureTime: null
            }
        ],
        origin: "LONDON_ST_PANCRAS",
        destination: "PARIS_NORD",
        status: "ACTIVE",
        planType: "SCHEDULED",
        country: "UK"
    };

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize JSON editor
        jsonEditor = CodeMirror(document.getElementById('jsonEditor'), {
            mode: 'application/json',
            theme: 'dracula',
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            foldGutter: true,
            gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
            lineWrapping: true,
            tabSize: 2
        });

        // Initialize XML viewer (read-only)
        xmlViewer = CodeMirror(document.getElementById('xmlViewer'), {
            mode: 'xml',
            theme: 'dracula',
            lineNumbers: true,
            readOnly: true,
            foldGutter: true,
            gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
            lineWrapping: true
        });

        // Load sample data by default
        loadSampleData();
        
        // Set placeholder for XML viewer
        xmlViewer.setValue('<!-- XML output will appear here after running the function -->\n\n<!-- Click "Run Function" to transform the JSON input to TAF-JSG XML format -->');
    });

    function loadSampleData() {
        jsonEditor.setValue(JSON.stringify(sampleData, null, 2));
    }

    function formatJson() {
        try {
            const content = jsonEditor.getValue();
            const parsed = JSON.parse(content);
            jsonEditor.setValue(JSON.stringify(parsed, null, 2));
            showNotification('success', 'JSON formatted successfully');
        } catch (error) {
            showNotification('error', 'Invalid JSON: ' + error.message);
        }
    }

    function clearInput() {
        jsonEditor.setValue('');
        xmlViewer.setValue('');
        currentOutput = '';
        hideError();
        document.querySelector('.output-card').classList.remove('has-content', 'has-error');
        document.getElementById('execution-time').classList.add('d-none');
        updateStatus('ready');
    }

    async function runFunction() {
        const functionUrl = document.getElementById('functionUrl').value.trim();
        if (!functionUrl) {
            showNotification('error', 'Please enter a function URL');
            return;
        }

        let input;
        try {
            input = jsonEditor.getValue();
            JSON.parse(input); // Validate JSON
        } catch (error) {
            showNotification('error', 'Invalid JSON input: ' + error.message);
            return;
        }

        // Show loading
        document.getElementById('loadingOverlay').style.display = 'flex';
        hideError();
        updateStatus('running');
        const startTime = performance.now();

        try {
            const response = await fetch('/api/FunctionDebug/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    functionUrl: functionUrl,
                    functionKey: document.getElementById('functionKey').value.trim(),
                    input: input
                })
            });

            const endTime = performance.now();
            const executionTime = ((endTime - startTime) / 1000).toFixed(2);

            const result = await response.json();

            if (result.success) {
                currentOutput = result.output;
                xmlViewer.setValue(formatXml(result.output));
                document.querySelector('.output-card').classList.add('has-content');
                document.querySelector('.output-card').classList.remove('has-error');
                updateStatus('success');
                showNotification('success', 'Function executed successfully');
            } else {
                currentOutput = '';
                xmlViewer.setValue('<!-- Error occurred - see error panel below -->');
                document.querySelector('.output-card').classList.add('has-error');
                document.querySelector('.output-card').classList.remove('has-content');
                showError(result.error, result.stackTrace);
                updateStatus('error');
            }

            // Show execution time
            document.getElementById('exec-time-value').textContent = executionTime + 's';
            document.getElementById('execution-time').classList.remove('d-none');

        } catch (error) {
            showError('Network error: ' + error.message, null);
            updateStatus('error');
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }

    function formatXml(xml) {
        try {
            let formatted = '';
            let indent = '';
            const tab = '  ';
            
            xml.split(/>\s*</).forEach(function(node) {
                if (node.match(/^\/\w/)) {
                    indent = indent.substring(tab.length);
                }
                formatted += indent + '<' + node + '>\n';
                if (node.match(/^<?\w[^>]*[^\/]$/) && !node.startsWith('?') && !node.startsWith('!')) {
                    indent += tab;
                }
            });
            
            return formatted.substring(1, formatted.length - 2);
        } catch (e) {
            return xml;
        }
    }

    function showError(message, stackTrace) {
        document.getElementById('errorPanel').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
        
        if (stackTrace) {
            document.getElementById('stackTraceContainer').style.display = 'block';
            document.getElementById('stackTrace').textContent = stackTrace;
        } else {
            document.getElementById('stackTraceContainer').style.display = 'none';
        }
    }

    function hideError() {
        document.getElementById('errorPanel').style.display = 'none';
    }

    function updateStatus(status) {
        const statusBadge = document.getElementById('function-status');
        switch (status) {
            case 'ready':
                statusBadge.className = 'badge bg-secondary';
                statusBadge.innerHTML = '<i class="bi bi-circle"></i> Ready';
                break;
            case 'running':
                statusBadge.className = 'badge bg-primary';
                statusBadge.innerHTML = '<i class="bi bi-hourglass-split"></i> Running...';
                break;
            case 'success':
                statusBadge.className = 'badge bg-success';
                statusBadge.innerHTML = '<i class="bi bi-check-circle"></i> Success';
                break;
            case 'error':
                statusBadge.className = 'badge bg-danger';
                statusBadge.innerHTML = '<i class="bi bi-x-circle"></i> Error';
                break;
        }
    }

    function copyOutput() {
        if (!currentOutput) {
            showNotification('error', 'No output to copy');
            return;
        }
        
        navigator.clipboard.writeText(currentOutput).then(() => {
            showNotification('success', 'Output copied to clipboard');
        }).catch(err => {
            showNotification('error', 'Failed to copy: ' + err.message);
        });
    }

    function downloadOutput() {
        if (!currentOutput) {
            showNotification('error', 'No output to download');
            return;
        }
        
        const blob = new Blob([currentOutput], { type: 'application/xml' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'transformed-output.xml';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        showNotification('success', 'File downloaded');
    }

    function toggleKeyVisibility() {
        const keyInput = document.getElementById('functionKey');
        const icon = document.getElementById('keyVisibilityIcon');
        if (keyInput.type === 'password') {
            keyInput.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            keyInput.type = 'password';
            icon.className = 'bi bi-eye';
        }
    }
</script>
}
